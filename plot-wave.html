<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>webaudio sample</title>
</head>
<body>
  <div id="main">
    <input type="file" id="files" name="files[]" />
    <button id="play">Play sound</button>
    <button id="draw">Draw graph</button>

    <div id="graph"></div>
  </div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var context = new AudioContext();
    var audioBuffer = null;

    function handleFileSelect(event) {
      var file = event.target.files[0];

      if (!file.type.match('audio.*')) {
        console.error('please upload audio file');
        return;
      }

      var reader = new FileReader();
      reader.onload = (function(theFile) {
        return function(e) {
          context.decodeAudioData(e.target.result, function(buffer) {
            audioBuffer = buffer;
          }, onError);
        };
      })(file);

      reader.readAsArrayBuffer(file);
    }

    function playSound(buffer) {
      var source = context.createBufferSource();
      source.buffer = buffer;
      source.connect(context.destination);
      source.start(0);
    }

    function play() {
      playSound(audioBuffer);
    }

    function _range(start, stop, step) {
      var index = 0;
      var length = (stop - start) / step;
      var result = Array(length);

      while(length) {
        result[index] = start;
        start += step;
        index += 1;
        length -= 1;
      }

      return result;
    }
    
    function draw() {
      var sampleRate = context.sampleRate;
      var len = audioBuffer.length;
      var t = _range(0.0, len / sampleRate, 1 / sampleRate);

      var center = len / 2;
      var cuttime = 0.04;
      var wav = audioBuffer.getChannelData(0);
      var wavdata = wav.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);
      var time = t.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);

      // plotly.js does not support typed array, so we should convert it to Array
      // like, Array.prototype.slice.call( Typed Array )
      var graph = document.getElementById('graph');
      Plotly.plot( graph, [{
        x: time.map(function(t) { return t * 1000;}),
        y: Array.prototype.slice.call(wavdata),
      }]);

    }

    function onError() {
      console.log("error happen");
    }
    document.getElementById('files').addEventListener('change', handleFileSelect, false);
    document.getElementById('play').addEventListener('click', play, false);
    document.getElementById('draw').addEventListener('click', draw, false);
  </script>
</body>
</html>
