<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>webaudio sample</title>
</head>
<body>
  <div id="main">
    <input type="file" id="files" name="files[]" />
    <button id="play">Play sound</button>
    <button id="draw">Draw graph</button>

    <div>
      <div style="display: inline-block;" id="wave"></div>
      <div style="display: inline-block;" id="pwave"></div>
    </div>

    <div>
      <div style="display: inline-block;" id="ampspectrum"></div>
      <div style="display: inline-block;" id="powerspectrum"></div>
    </div>
  </div>

  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script>
    window.AudioContext = window.AudioContext || window.webkitAudioContext;
    var context = new AudioContext();
    var audioBuffer = null;

    function handleFileSelect(event) {
      var file = event.target.files[0];

      if (!file.type.match('audio.*')) {
        console.error('please upload audio file');
        return;
      }

      var reader = new FileReader();
      reader.onload = (function(theFile) {
        return function(e) {
          context.decodeAudioData(e.target.result, function(buffer) {
            audioBuffer = buffer;
          }, onError);
        };
      })(file);

      reader.readAsArrayBuffer(file);
    }

    function playSound(buffer) {
      var source = context.createBufferSource();
      source.buffer = buffer;
      source.connect(context.destination);
      source.start(0);
    }

    function play() {
      playSound(audioBuffer);
    }

    function _range(start, stop, step) {
      var index = 0;
      var length = (stop - start) / step;
      var result = Array(length);

      while(length) {
        result[index] = start;
        start += step;
        index += 1;
        length -= 1;
      }

      return result;
    }

    function draw() {
      var sampleRate = context.sampleRate;
      var len = audioBuffer.length;
      var t = _range(0.0, len / sampleRate, 1 / sampleRate);

      var center = len / 2;
      var cuttime = 0.04;
      var wav = audioBuffer.getChannelData(0);
      var wavdata = wav.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);
      var time = t.slice(center - cuttime/2*sampleRate, center + cuttime/2*sampleRate);

      var owavdata = wavdata.slice();

      // pre-emphasis filter
      var pwavdata = preEmphasis(wavdata, 0.97);

      var hammingWindow = hamming(pwavdata.length);
      for(var i = 0; i < pwavdata.length; i +=1 ) {
        pwavdata[i] *= hammingWindow[i]
      }

      // DFT
      // number of samples
      var n = 2048
      var im = [];
      [wavdata, im] = minifft(pwavdata, n);


      var Adft = [],
          Pdft = [],
          freqList = [];
      for (var i = 0; i < n/2; i+=1) {
        Pdft[i] = wavdata[i] * wavdata[i] + im[i] * im[i]
        Adft[i] = Math.sqrt(Pdft[i]);
        freqList[i] = i * sampleRate / n;
      }

      // plotly.js does not support typed array, so we should convert it to Array
      // like, Array.prototype.slice.call( Typed Array )
      var graph = document.getElementById('wave');
      Plotly.plot( graph, [{
        x: time.map(function(t) { return t * 1000;}),
        y: Array.prototype.slice.call(owavdata),
      }]);
      var graph = document.getElementById('pwave');
      Plotly.plot( graph, [{
        x: time.map(function(t) { return t * 1000;}),
        y: Array.prototype.slice.call(pwavdata),
      }]);

      var graph = document.getElementById('ampspectrum');
      Plotly.plot( graph, [{
        x: freqList,
        y: Adft,
      }]);
      var graph = document.getElementById('powerspectrum');
      Plotly.plot( graph, [{
        x: freqList,
        y: Pdft,
      }]);
    }

    /*
     * hamming window
     *   w(n) = 0.54 - 0.46 cos( 2 PI n / (M - 1) ), 0 <= n <= M - 1
     */
     function hamming(n) {
       var w = [];
       for(var i = 0; i < n; i += 1) {
         w[i] = 0.54 - 0.46 * Math.cos( 2.0 * Math.PI * i / (n - 1));
       }
       return w;
     }

    /*
     * pre emphasis filter
     *   y(n) = x(n) - p x(n - 1)
     */
    function preEmphasis(signal, p = 0.97) {
      var y = [];
      y[0] = signal[0];
      for(var i = 1; i < signal.length; i+=1){
        y[i] = signal[i] - ( p * signal[i - 1]);
      }

      return y;
    }

    function minifft(data, n = 0) {
      var N = n || data.length;
      if(data.length < n) {
        var re = Array.prototype.slice.call(data).concat(new Array(n - data.length).fill(0));
      } else {
        var re = data.slice(0, n);
      }
      var im = new Array(n).fill(0);

      for (var i = 0; i < N; i+=1) {
        for(var j = 0, h = i, k = N; k >>= 1; h >>= 1) {
          j = (j << 1) | (h & 1);
        }
        if (j > i) {
          re[j] = [re[i], re[i] = re[j]][0];
          im[j] = [im[i], im[i] = im[j]][0];
        }
      }
      for(var hN = 1; hN * 2 <= N; hN *= 2) {
        for(var i = 0; i < N; i+= hN * 2) {
          for(var j = i; j < i + hN; j+=1) {
            var cos = Math.cos(Math.PI * (j - i) / hN),
                sin = Math.sin(Math.PI * (j - i) / hN);
            var tre =  re[j+hN] * cos + im[j+hN] * sin,
                tim = -re[j+hN] * sin + im[j+hN] * cos;
            re[j+hN] = re[j] - tre;
            im[j+hN] = im[j] - tim;
            re[j] += tre;
            im[j] += tim;
          }
        }
      }

      return [re, im];
    }

    function onError() {
      console.log("error happen");
    }
    document.getElementById('files').addEventListener('change', handleFileSelect, false);
    document.getElementById('play').addEventListener('click', play, false);
    document.getElementById('draw').addEventListener('click', draw, false);
  </script>
</body>
</html>
